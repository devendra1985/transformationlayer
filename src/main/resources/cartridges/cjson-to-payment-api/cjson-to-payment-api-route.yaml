# ============================================================================
# CJSON to Payment API Cartridge Route
# ============================================================================
# This route defines the processing pipeline for transforming CJSON messages
# to the downstream Payment API format.
#
# Stages:
#   1. validate  - Load mapping definition, validate input against rules
#   2. enrich    - Apply enrichment rules (add/modify fields)
#   3. transform - Map fields from source to target format
#   4. HTTP POST - Send to downstream Payment API
# ============================================================================

- route:
    id: cjson-to-payment-api-route
    from:
      uri: "direct:cjson-to-payment-api"
      steps:
        # ====================================================================
        # STAGE 1: VALIDATION
        # Loads mapping definition and validates input against defined rules
        # ====================================================================
        - bean:
            ref: validate
            method: process

        # ====================================================================
        # STAGE 2: ENRICHMENT / ENHANCEMENT
        # Applies enrichment rules: set static values, copy fields, call beans
        # ====================================================================
        - bean:
            ref: enrich
            method: process

        # ====================================================================
        # STAGE 3: TRANSFORMATION
        # Maps source fields to target fields per mapping rules
        # ====================================================================
        - bean:
            ref: transform
            method: process

        # ====================================================================
        # STAGE 4: OUTPUT - Send to downstream Payment API
        # ====================================================================
        - marshal:
            json: { }
        - convertBodyTo:
            type: java.lang.String
        - setHeader:
            name: CamelHttpMethod
            constant: POST
        - setHeader:
            name: Content-Type
            constant: application/json
        - log:
            message: "Sending transformed payload to Payment API: ${body}"
            loggingLevel: INFO
        - toD: "{{app.payment-api.base-url}}{{app.payment-api.path}}?bridgeEndpoint=true"
        - unmarshal:
            json: { }
        - setHeader:
            name: Content-Type
            constant: application/json

