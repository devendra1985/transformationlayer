# ============================================================================
# VISA VISABA - Base/Fallback Mapping & Validation Rules
# ============================================================================

cartridgeId: VISABA

output:
  type: json

validations:
  - path: $.payoutMethod
    required: true
    pattern: '^[BW]$'

  - path: $.recipientDetail.type
    required: true
    pattern: '^[IC]$'

  - path: $.recipientDetail.bank.accountName
    required: true
    minLength: 1
    maxLength: 70
    whenPath: $.payoutMethod
    whenEquals: "B"

  - path: $.recipientDetail.bank.accountNumber
    required: true
    minLength: 1
    maxLength: 254
    whenPath: $.payoutMethod
    whenEquals: "B"

  - path: $.recipientDetail.bank.accountNumberType
    required: true
    pattern: '^(IBAN|ALIAS|DEFAULT)$'
    whenPath: $.payoutMethod
    whenEquals: "B"

  - path: $.recipientDetail.bank.countryCode
    required: true
    minLength: 3
    maxLength: 3
    pattern: '^[A-Z]{3}$'
    whenPath: $.payoutMethod
    whenEquals: "B"

  - path: $.recipientDetail.bank.currencyCode
    required: true
    minLength: 3
    maxLength: 3
    pattern: '^[A-Z]{3}$'
    whenPath: $.payoutMethod
    whenEquals: "B"

  - path: $.senderDetail.type
    required: true
    pattern: '^[IC]$'

  - path: $.senderDetail.address.addressLine1
    required: true
    minLength: 1
    maxLength: 50

  - path: $.senderDetail.address.city
    required: true
    minLength: 1
    maxLength: 35

  - path: $.senderDetail.address.country
    required: true
    minLength: 3
    maxLength: 3
    pattern: '^[A-Z]{3}$'

  - path: $.transactionDetail.businessApplicationId
    required: true
    minLength: 2
    maxLength: 2

  - path: $.transactionDetail.clientReferenceId
    required: true
    minLength: 1
    maxLength: 35
    pattern: '^[A-Za-z0-9\\-]+$'

  - path: $.transactionDetail.initiatingPartyId
    required: true

  - path: $.transactionDetail.transactionAmount
    required: true
    min: 0.01

  - path: $.transactionDetail.transactionCurrencyCode
    required: true
    minLength: 3
    maxLength: 3
    pattern: '^[A-Z]{3}$'

  - path: $.transactionDetail.settlementCurrencyCode
    required: true
    minLength: 3
    maxLength: 3
    pattern: '^[A-Z]{3}$'

  - path: $.transactionDetail.senderSourceOfFunds
    required: true
    pattern: '^(01|02|03|04|05|06)$'

mappings:
  # Recipient detail
  - source: $.cdtrNm
    target: recipientDetail.name
    required: true

  - source: $.recipientType
    target: recipientDetail.type
    defaultValue: "I"

  - source: $.cdtrPstlAdrCtry
    target: recipientDetail.address.country
    required: true

  - source: $.cdtrPstlAdrTwnNm
    target: recipientDetail.address.city

  - source: $.cdtrPstlAdrPstCd
    target: recipientDetail.address.postalCode

  - source: $.cdtrPstlAdrStrtNm
    target: recipientDetail.address.addressLine1

  - source: $.cdtrPstlAdrBldgNb
    target: recipientDetail.address.addressLine2

  - source: $.cdtrAgtBic
    target: recipientDetail.bank.bankCode

  - source: $.cdtrAgtClrSysMmbId
    target: recipientDetail.bank.bankCode

  - source: $.cdtrAgtNm
    target: recipientDetail.bank.bankName

  - source: $.cdtrAcctNm
    target: recipientDetail.bank.accountName

  - source: $.cdtrAcctIban
    target: recipientDetail.bank.accountNumber
    required: true

  - source: $.crAcctCcy
    target: recipientDetail.bank.currencyCode

  - source: $.cdtrPstlAdrCtry
    target: recipientDetail.bank.countryCode
    required: true

  - source: $.cdtrAcctOthrId
    target: recipientDetail.bank.accountNumber

  - source: $.cdtrAgtBic
    target: recipientDetail.bank.BIC

  - source: $.brnchCd
    target: recipientDetail.bank.branchCode

  # Sender detail
  - source: $.dbtrNm
    target: senderDetail.name
    required: true

  - source: $.dbtrAcctIban
    target: senderDetail.senderAccountNumber
    required: true

  - source: $.dbtrPstlAdrCtry
    target: senderDetail.address.country

  - source: $.dbtrPstlAdrTwnNm
    target: senderDetail.address.city

  - source: $.dbtrPstlAdrStrtNm
    target: senderDetail.address.addressLine1

  - source: $.dbtrPstlAdrBldgNb
    target: senderDetail.address.addressLine2

  # Payout method
  - source: $.payoutMethod
    target: payoutMethod
    defaultValue: "B"

  # Transaction detail
  - source: $.initiatingPartyId
    target: transactionDetail.initiatingPartyId
    defaultValue: "1002"

  - source: $.paymentId
    target: transactionDetail.clientReferenceId
    required: true

  - source: $.rmtInfUstrd.0
    target: transactionDetail.statementNarrative

  - source: $.crPymtAmt
    target: transactionDetail.transactionAmount
    required: true

  - source: $.crPymtAmtCcy
    target: transactionDetail.transactionCurrencyCode
    required: true

  - source: $.crAcctCcy
    target: transactionDetail.settlementCurrencyCode

  - source: $.businessApplicationId
    target: transactionDetail.businessApplicationId
    defaultValue: "FD"

  - source: $.senderSourceOfFunds
    target: transactionDetail.senderSourceOfFunds
    defaultValue: "05"
